image: node:8.16

services:
  - trufflesuite/ganache-cli

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - prediction-market/node_modules/
  - prediction-market/app/node_modules/

stages:
  - install
  - build
  - test
  - deploy
  
node_deps:
  stage: install
  script:
  - cd prediction-market/
  - npm install truffle
  - npm install
  - cd app
  - npm install
  rules:
   - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
     when: on_success
   - changes:
     - prediction-market/package.json
     - prediction-market/app/package.json
     when: on_success

build_prediction_market:
  stage: build
  script:
   - cd prediction-market/
   - ./node_modules/truffle/build/cli.bundled.js compile
   - cd app
   - npm run build
  artifacts:
   paths:
   - prediction-market/app/src/contracts
   - prediction-market/app/build
  rules:
   - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
     when: on_success
   - changes:
     - prediction-market/*
     when: on_success
   
build_agent:
  stage: build
  script:
   - cd agent/
   - echo "nothing to build for agent"
  rules:
   - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
     when: on_success
   - changes:
     - agent/*
     when: on_success

test_prediction_market:
  stage: test
  dependencies:
   - build_prediction_market
  script:
   - cd prediction-market/
   - ./node_modules/truffle/build/cli.bundled.js test --network testing
  rules:
   - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
     when: on_success
   - changes:
     - prediction-market/*
     when: on_success
   
test_agent:
  stage: test
  script:
   - echo "nothing to test for agent"
  rules:
   - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
     when: on_success
   - changes:
     - agent/*
     when: on_success


deploy_contracts:
  stage: deploy
  script:
   - cd prediction-market/
   - ./node_modules/truffle/build/cli.bundled.js migrate --network master
  only:
   refs: 
   - master
   changes: 
   - prediction-market/contracts/*

deploy_app:
  stage: deploy
  dependencies:
   - build_prediction_market
  script:
   - cp -R ./prediction-market/app/build/* /host/charje/
  only:
   refs: 
   - master
   changes: 
   - prediction-market/app/*
